<script>
	var divs = document.querySelectorAll('#slNo1');
	for (var i = 0; i < divs.length; ++i) {
		divs[i].innerHTML = i + 1;
	}
	var divs = document.querySelectorAll('#slNo2');
	for (var i = 0; i < divs.length; ++i) {
		divs[i].innerHTML = i + 1;
	}
	var divs = document.querySelectorAll('#slNo3');
	for (var i = 0; i < divs.length; ++i) {
		divs[i].innerHTML = i + 1;
	}
	$(document).ready(function () {
		$('#categoryOfferList').DataTable();
		$('#productOfferList').DataTable();
		$('#productList').DataTable();
	});



	$("#createCategoryOffer").submit((e) => {
		e.preventDefault()
		$.ajax({
			url: '/admin/category-offer',
			data: $('#createCategoryOffer').serialize(),
			method: 'post',
			success: async (response) => {
				if (response.offerNameExist) {
					document.getElementById("categoryOfferNameErr").innerHTML = "Offer already exist!"
				} else if (response.categoryOfferExist) {
					document.getElementById("categoryOfferErr").innerHTML = "Category Offer already exist!"
				} else {
					await Swal.fire({
						position: 'inherit',
						icon: 'success',
						title: 'New Category Offer created and applied successfully',
						showConfirmButton: false,
						timer: 2000
					})
					location.reload()
				}

			}
		})
	})

	$("#createProductOffer").submit((e) => {
		e.preventDefault()
		$.ajax({
			url: '/admin/product-offer',
			data: $('#createProductOffer').serialize(),
			method: 'post',
			success: async (response) => {
				if (response.productOfferExist) {
					document.getElementById("productOfferErr").innerHTML = "Offer already exist!"
				} else {
					await Swal.fire({
						position: 'inherit',
						icon: 'success',
						title: 'New Offer has been created',
						showConfirmButton: false,
						timer: 1500
					})
					location.reload()
				}

			}
		})
	})

	function applyProductOffer(productId) {
		let st = document.getElementById(productId)
		let offer = st.options[st.selectedIndex].text

		$.ajax({
			url: '/admin/apply-product-offer',
			data: {
				proId: productId,
				offerName: offer
			},
			method: 'post',
			success: (response) => {
				console.log("Success ayi")
				custom = offer
				location.reload()
			}
		})
	}

	function removeCategoryOffer(offerId, offerName, offCategory) {
		Swal.fire({
			title: 'Are you want to delete ' + offerName,
			text: "You won't be able to revert this!",
			icon: 'warning',
			showCancelButton: true,
			confirmButtonColor: '#3085d6',
			cancelButtonColor: '#d33',
			confirmButtonText: 'Yes, delete it!'
		}).then((result) => {
			if (result.isConfirmed) {
				$.ajax({
					url: '/admin/remove-category-offer',
					data: {
						offerId: offerId,
						offCategory: offCategory
					},
					method: 'post',
					success: (response) => {
						location.reload()
					}
				})
			} else {

			}
		})



	}
</script>

<script>
	router.get('/', async function (req, res, next) {
		let banner;
		const perPage = 16;
		let pageNum;
		let skip;
		let productCount;
		let pages;
		pageNum = parseInt(req.query.page);
		console.log(typeof (pageNum))
		skip = (pageNum - 1) * perPage
		await productHelpers.getProductCount().then((count) => {
			productCount = count;
		})
		pages = Math.ceil(productCount / perPage)

		Handlebars.registerHelper('ifCond', function (v1, v2, options) {
			if (v1 === v2) {
				return options.fn(this);
			}
			return options.inverse(this);
		});
		Handlebars.registerHelper('for', function (from, to, incr, block) {
			var accum = '';
			for (var i = from; i <= to; i += incr)
				accum += block.fn(i);
			return accum;
		});



		await productHelpers.getActiveBanner().then((activeBanner) => {
			banner = activeBanner;
		})
		console.log(banner, 'banner')
		await productHelpers.getAllCategories().then(async (categories) => {

			await productHelpers.getPaginatedProducts(skip, perPage).then((products) => {

				res.render('user/view-products', { products, categories, totalDoc: productCount, currentPage: pageNum, pages: pages, banner: banner })
				
			})
		})

	});
</script>




</script>